<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∫–∞—Ä—Ç—ã</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #333;
      color: white;
      padding: 10px 20px;
      font-size: 20px;
    }
    main {
      display: flex;
      flex: 1;
    }
    #controls {
      width: 40%;
      padding: 20px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
    }
    #map-preview {
      flex: 1;
      background: #ddd;
      position: relative;
    }
    #map-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }
    .preview-marker {
      position: absolute;
      width: 20px;
      height: 20px;
      background: red;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: grab;
    }
    .preview-marker:active {
      cursor: grabbing;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background-color: #f0f0f0;
    }
    button {
      margin-right: 6px;
    }
    form input, form textarea, form select {
      width: 100%;
      margin-bottom: 10px;
      padding: 6px;
      font-size: 14px;
    }
    #login-screen {
      position: fixed;
      inset: 0;
      background: #000000cc;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 10000;
    }
    #login-screen input {
      padding: 10px;
      font-size: 16px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="login-screen">
    <h2>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø–∞</h2>
    <input type="password" id="admin-password" placeholder="–ü–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter') checkPassword()">
    <button onclick="checkPassword()">–í–æ–π—Ç–∏</button>
  </div>

  <header>üó∫ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç–µ</header>
  <main>
    <section id="controls">
      <h2>–î–æ–±–∞–≤–∏—Ç—å / –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ—á–∫—É</h2>
      <form id="point-form">
        <input type="hidden" id="edit-index">
        <label>X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞:<input type="number" id="x"></label>
        <label>Y –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞:<input type="number" id="y"></label>
        <label>–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É:<input type="text" id="image"></label>
        <label>–û–ø–∏—Å–∞–Ω–∏–µ:
          <textarea id="text" list="recent-texts"></textarea>
          <datalist id="recent-texts"></datalist>
        </label>
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:
          <input type="text" id="category" list="category-list">
          <datalist id="category-list">
            <option>–ü–∞–º—è—Ç–Ω–∏–∫</option>
            <option>–ü–∞—Ä–∫–æ–≤–∞—è –∑–æ–Ω–∞</option>
            <option>–ó–¥–∞–Ω–∏–µ</option>
            <option>–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞</option>
          </datalist>
        </label>
        <label>–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):<input type="text" id="tags"></label>
        <label>–ò–∫–æ–Ω–∫–∞:
          <select id="icon">
            <option value="default">üî¥ –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
            <option value="blue">üîµ –°–∏–Ω—è—è</option>
            <option value="green">üü¢ –ó–µ–ª—ë–Ω–∞—è</option>
            <option value="yellow">üü° –ñ—ë–ª—Ç–∞—è</option>
            <option value="black">‚ö´ –ß—ë—Ä–Ω–∞—è</option>
          </select>
        </label>
        <button type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" onclick="resetForm()">‚Ü© –û—á–∏—Å—Ç–∏—Ç—å</button>
      </form>


      <h2>–°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫</h2>
      <table id="points-table">
        <thead>
          <tr>
            <th>#</th><th>X</th><th>Y</th><th>–§–æ—Ç–æ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–¢–µ–≥–∏</th><th>–ò–∫–æ–Ω–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <button onclick="saveJSON()">üíæ –û–±–Ω–æ–≤–∏—Ç—å points.json</button>
      <input type="file" accept="application/json" onchange="uploadJSON(this)">
    </section>
    <section id="map-preview">
      <img id="map-image" src="tiles/tile_0_0.jpg" alt="–ö–∞—Ä—Ç–∞">
    </section>
  </main>

<script>
let points = [];
let recentTexts = [];
const mapSize = 28928;
const preview = document.getElementById('map-preview');

function checkPassword() {
  const password = document.getElementById('admin-password').value;
  if (password === '1234') {
    document.getElementById('login-screen').style.display = 'none';
  } else {
    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
  }
}

preview.addEventListener('click', (e) => {
  const rect = preview.getBoundingClientRect();
  const x = Math.round(((e.clientX - rect.left) / rect.width) * mapSize);
  const y = Math.round(((e.clientY - rect.top) / rect.height) * mapSize);
  document.getElementById('x').value = x;
  document.getElementById('y').value = y;
});

function renderTable() {
  const tbody = document.querySelector('#points-table tbody');
  tbody.innerHTML = '';
  preview.querySelectorAll('.preview-marker').forEach(m => m.remove());

  points.forEach((p, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${i + 1}</td>
      <td>${p.x}</td>
      <td>${p.y}</td>
      <td><img src="${p.image}" width="50"></td>
      <td>${p.text}</td>
      <td>${p.category || ''}</td>
      <td>${(p.tags || []).join(', ')}</td>
      <td>${p.icon || 'default'}</td>
      <td>
        <button onclick="editPoint(${i})">‚úèÔ∏è</button>
        <button onclick="deletePoint(${i})">üóë</button>
      </td>
    `;
    tbody.appendChild(row);

    const marker = document.createElement('div');
    marker.className = 'preview-marker';
    marker.style.left = (p.x / mapSize * 100) + '%';
    marker.style.top = (p.y / mapSize * 100) + '%';
    marker.title = p.text;
    marker.draggable = true;

    // –¶–≤–µ—Ç –∏–∫–æ–Ω–∫–∏
    const colors = {
      blue: 'blue',
      green: 'green',
      yellow: 'gold',
      black: '#000',
      default: 'red'
    };
    marker.style.background = colors[p.icon] || 'red';

    let offsetX = 0, offsetY = 0;

    marker.addEventListener('dragstart', e => {
      offsetX = e.offsetX;
      offsetY = e.offsetY;
    });

    marker.addEventListener('dragend', e => {
      const rect = preview.getBoundingClientRect();
      const relX = e.clientX - rect.left - offsetX;
      const relY = e.clientY - rect.top - offsetY;

      const normX = Math.round((relX / rect.width) * mapSize);
      const normY = Math.round((relY / rect.height) * mapSize);

      points[i].x = normX;
      points[i].y = normY;

      document.getElementById('x').value = normX;
      document.getElementById('y').value = normY;

      renderTable();
    });

    marker.onclick = () => editPoint(i);
    preview.appendChild(marker);
  });

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫
  const textList = document.getElementById('recent-texts');
  textList.innerHTML = recentTexts.map(t => `<option value="${t}">`).join('');
}

document.getElementById('point-form').addEventListener('submit', function(e) {
  e.preventDefault();
  const x = parseInt(document.getElementById('x').value);
  const y = parseInt(document.getElementById('y').value);
  const image = document.getElementById('image').value;
  const text = document.getElementById('text').value;
  const category = document.getElementById('category').value;
  const tags = document.getElementById('tags').value.split(',').map(t => t.trim());
  const icon = document.getElementById('icon').value;
  const index = document.getElementById('edit-index').value;

  if (text && !recentTexts.includes(text)) {
    recentTexts.unshift(text);
    if (recentTexts.length > 10) recentTexts.pop();
  }

  const point = { x, y, image, text, category, tags, icon };

  if (index !== '') {
    points[index] = point;
  } else {
    points.push(point);
  }

  resetForm();
  renderTable();
});

function editPoint(i) {
  const p = points[i];
  document.getElementById('x').value = p.x;
  document.getElementById('y').value = p.y;
  document.getElementById('image').value = p.image;
  document.getElementById('text').value = p.text;
  document.getElementById('category').value = p.category || '';
  document.getElementById('tags').value = (p.tags || []).join(', ');
  document.getElementById('icon').value = p.icon || 'default';
  document.getElementById('edit-index').value = i;
}

function deletePoint(i) {
  if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç–æ—á–∫—É?')) {
    points.splice(i, 1);
    renderTable();
  }
}

function resetForm() {
  document.getElementById('point-form').reset();
  document.getElementById('edit-index').value = '';
}

function uploadJSON(input) {
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = function() {
    points = JSON.parse(reader.result);
    renderTable();
  };
  reader.readAsText(file);
}

function saveJSON() {
  const blob = new Blob([JSON.stringify(points, null, 2)], { type: 'application/json' });

  if (window.showSaveFilePicker) {
    window.showSaveFilePicker({
      suggestedName: 'points.json',
      types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
    }).then(async handle => {
      const writable = await handle.createWritable();
      await writable.write(blob);
      await writable.close();
      alert('–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
    }).catch(() => {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'points.json';
      a.click();
    });
  } else {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'points.json';
    a.click();
  }
}

fetch('points.json')
  .then(res => res.json())
  .then(json => {
    points = json;
    renderTable();
  })
  .catch(err => console.warn('points.json –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω'));
</script>
</body>
</html>
